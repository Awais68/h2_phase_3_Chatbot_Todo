"""
Agent service for OpenAI Agents SDK integration.
"""
from typing import List, Dict, Any, Optional
from openai import OpenAI
import os
import json
from dotenv import load_dotenv
from src.mcp.server import mcp_server

# Load environment variables from .env file
load_dotenv()


class AgentService:
    """Service for managing AI agent interactions."""

    def __init__(self):
        """Initialize the agent service."""
        api_key = os.getenv("OPENAI_API_KEY")
        if not api_key:
            raise ValueError("OPENAI_API_KEY environment variable is required")
        self.client = OpenAI(api_key=api_key)
        self.model = "gpt-4o-mini"  # Changed from gpt-4 to gpt-4o-mini for API key compatibility
        self.system_prompt = """You are a helpful task management assistant. Users will ask you to manage their todo tasks using natural language.

Your capabilities:
- Create tasks: "add", "create", "remember", "new task", "I need to"
- List tasks: "show", "list", "what are", "see tasks", "my tasks"
- Complete tasks: "done", "complete", "finished", "mark as done"
- Update tasks: "change", "update", "rename", "modify", "edit"
- Delete tasks: "delete", "remove", "cancel"
- Recurring tasks: "create recurring", "daily task", "weekly reminder", "monthly task"
- Analytics: "show statistics", "task analytics", "productivity", "completion rate"

Always:
- Confirm actions with friendly messages
- Use status indicators (✓ for success, ✗ for errors)
- Format task lists clearly with numbers or bullets
- Ask for clarification if the request is ambiguous
- Provide helpful error messages if something fails
- Be conversational and natural

When listing tasks, format them clearly with status indicators."""

    def run_agent(
        self,
        messages: List[Dict[str, str]],
        user_id: int,
        session: Any = None
    ) -> Dict[str, Any]:
        """
        Run the AI agent with conversation history and available tools.

        Args:
            messages: Conversation history (list of message dicts)
            user_id: User ID for tool execution
            session: Database session for tool execution

        Returns:
            Dict with response and tool_calls
        """
        # Get tool definitions
        tools = mcp_server.get_tool_definitions()

        # Add system prompt
        full_messages = [{"role": "system", "content": self.system_prompt}] + messages

        # Call OpenAI API
        response = self.client.chat.completions.create(
            model=self.model,
            messages=full_messages,
            tools=tools,
            tool_choice="auto"
        )

        message = response.choices[0].message
        tool_calls = []

        # Execute tool calls if any
        if message.tool_calls:
            for tool_call in message.tool_calls:
                tool_name = tool_call.function.name
                tool_args = json.loads(tool_call.function.arguments)  # Parse JSON arguments securely

                # Add user_id and session to tool args
                tool_args["user_id"] = user_id
                tool_args["session"] = session

                # Execute tool
                try:
                    result = mcp_server.execute_tool(tool_name, **tool_args)
                    tool_calls.append({
                        "tool": tool_name,
                        "arguments": tool_args,
                        "result": result
                    })
                except Exception as e:
                    tool_calls.append({
                        "tool": tool_name,
                        "arguments": tool_args,
                        "error": str(e)
                    })

        return {
            "response": message.content or "",
            "tool_calls": tool_calls
        }


# Global agent service instance
agent_service = AgentService()
